<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | History</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #000; --card: #111; --accent: #4ade80; --border: #222; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        .header-section { position: sticky; top: 0; background: var(--bg); padding-bottom: 10px; z-index: 100; border-bottom: 1px solid #222; margin-bottom: 15px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; padding-top: 5px; }
        .back-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        
        .search-container { position: relative; margin-bottom: 10px; }
        .search-bar { width: 100%; background: var(--card); border: 1px solid var(--border); padding: 10px 35px; border-radius: 8px; color: #fff; box-sizing: border-box; font-size: 14px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #555; font-size: 12px; }

        .filter-select { background: #1a1a1a; color: var(--accent); border: 1px solid #333; padding: 8px; border-radius: 8px; width: 100%; margin-bottom: 10px; font-size: 13px; font-weight: bold; }

        /* Updated Summary Card */
        .stats-card { background: #080808; border: 1px solid var(--accent); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(74, 222, 128, 0.1); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .stat-item { background: #111; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #222; }
        .stat-val { display: block; font-size: 18px; font-weight: bold; color: var(--accent); }
        .stat-lbl { font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        .included-cons { border-top: 1px solid #222; padding-top: 10px; }
        .included-lbl { font-size: 10px; color: var(--accent); margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px; }
        
        /* New Consignment Badge Style */
        .cons-badge { display: inline-flex; align-items: center; background: #1a1a1a; border: 1px solid #333; padding: 4px 10px; border-radius: 6px; font-size: 11px; margin: 3px; color: #eee; }
        .bag-count-small { background: var(--accent); color: #000; font-weight: bold; padding: 1px 5px; border-radius: 3px; margin-left: 6px; font-size: 10px; }

        .history-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 12px; border-left: 3px solid var(--accent); }
        .card-date { font-size: 10px; color: #555; margin-bottom: 5px; }
        .card-id { color: var(--accent); font-weight: bold; font-size: 15px; margin-bottom: 8px; }
        .item-row { background: #050505; padding: 8px; border-radius: 6px; margin-top: 5px; border: 1px solid #1a1a1a; }
        .subtotal { text-align: right; color: var(--accent); font-weight: bold; font-size: 13px; margin-top: 8px; padding-top: 5px; border-top: 1px solid #222; }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="header">
            <a href="reciver.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>
            <h2 style="margin:0; font-size: 16px;">History leh Summary</h2>
        </div>

        <div class="search-container">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" class="search-bar" placeholder="Zawnna (ID, Date, Item...)" onkeyup="filterData()">
        </div>

        <select id="timeFilter" class="filter-select" onchange="filterData()">
            <option value="all">A vaiin (All Time)</option>
            <option value="7">Tun kar (7 Days)</option>
            <option value="30">Tun thla (30 Days)</option>
        </select>
    </div>

    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item"><span class="stat-val" id="totalPcsStat">0</span><span class="stat-lbl">Total Pcs</span></div>
            <div class="stat-item"><span class="stat-val" id="totalBagsStat">0</span><span class="stat-lbl">Total Bags</span></div>
        </div>
        <div class="included-cons">
            <div class="included-lbl">CONSIGNMENT & BAG DETAILS:</div>
            <div id="consList"></div>
        </div>
    </div>

    <div id="history-display"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUEe_nqxaUKrYBjSJssxuRzns8AHsLkX0",
            authDomain: "kimkimenterprise-516c4.firebaseapp.com",
            projectId: "kimkimenterprise-516c4",
            storageBucket: "kimkimenterprise-516c4.firebasestorage.app",
            messagingSenderId: "782456699398",
            appId: "1:782456699398:web:c069d267ea8d62b197e187"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let masterData = [];

        onSnapshot(query(collection(db, "history_data"), orderBy("timestamp", "desc")), (snapshot) => {
            masterData = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const snap = data.snapshot || {};
                const ts = data.timestamp ? data.timestamp.toDate() : new Date();
                
                for (const [cNo, cData] of Object.entries(snap)) {
                    masterData.push({
                        dateObj: ts,
                        dateStr: data.date,
                        consignmentNo: cNo,
                        searchString: `${cNo} ${data.date} ${Object.keys(cData.items).join(' ')}`.toLowerCase(),
                        ...cData
                    });
                }
            });
            filterData();
        });

        window.filterData = () => {
            const timeVal = document.getElementById('timeFilter').value;
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const now = new Date();
            let filtered = masterData;

            if (timeVal !== "all") {
                const limit = new Date();
                limit.setDate(now.getDate() - parseInt(timeVal));
                filtered = filtered.filter(item => item.dateObj >= limit);
            }
            if (searchVal) {
                filtered = filtered.filter(item => item.searchString.includes(searchVal));
            }
            render(filtered);
        };

        function render(data) {
            const listDiv = document.getElementById('history-display');
            const consListDiv = document.getElementById('consList');
            let html = "";
            let consTags = "";
            let tPcs = 0;
            let tBags = 0;

            data.forEach(item => {
                tPcs += item.grandTotal;
                tBags += item.bagCount;
                
                // Added bag count specifically here for the summary list
                consTags += `
                    <div class="cons-badge">
                        <span>${item.consignmentNo}</span>
                        <span class="bag-count-small">${item.bagCount} Bags</span>
                    </div>`;

                html += `
                <div class="history-card">
                    <div class="card-date">${item.dateStr}</div>
                    <div class="card-id">ID: ${item.consignmentNo}</div>`;
                
                for (const [itemName, sizes] of Object.entries(item.items)) {
                    html += `<div class="item-row"><strong>${itemName}</strong>`;
                    for (const [sz, info] of Object.entries(sizes)) {
                        html += `<div style="color:#777; font-size:11px;">â€¢ Size ${sz}: ${info.totalPcs} pcs</div>`;
                    }
                    html += `</div>`;
                }
                html += `<div class="subtotal">Subtotal: ${item.grandTotal} pcs</div></div>`;
            });

            document.getElementById('totalPcsStat').innerText = tPcs.toLocaleString();
            document.getElementById('totalBagsStat').innerText = tBags;
            consListDiv.innerHTML = consTags || '<span style="color:#444; font-size:11px;">A hmu zo lo.</span>';
            listDiv.innerHTML = html || '<div style="text-align:center; padding:50px; color:#444;">No records found.</div>';
        }
    </script>
</body>
</html>
