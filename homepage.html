<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KimKim Inventory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #000; --card: #111; --border: #222;
            --text: #fff; --gray: #888; --accent: #4ade80; --blue: #3b82f6;
        }
        body { 
            margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif;
            color: var(--text); display: flex; flex-direction: column;
            min-height: 100vh;
        }
        .header { 
            position: sticky; top: 0; z-index: 3000;
            padding: 12px; background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); 
        }
        .search-bar { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: #fff; outline: none; box-sizing: border-box; font-size: 14px; }
        
        /* Category Ribbon Styling */
        .category-ribbon { 
            display: flex; overflow-x: auto; gap: 10px; padding: 10px; 
            background: #000; border-bottom: 1px solid var(--border);
            scrollbar-width: none;
        }
        .category-ribbon::-webkit-scrollbar { display: none; }
        .cat-chip { 
            white-space: nowrap; padding: 7px 15px; border-radius: 20px; 
            background: var(--card); border: 1px solid var(--border); 
            font-size: 12px; font-weight: 600; color: var(--gray); cursor: pointer;
        }
        .cat-chip.active { background: var(--accent); color: #000; border-color: var(--accent); }

        .main-content { 
            flex-grow: 1; padding: 10px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            padding-bottom: 100px; 
        }
        
        .item-card { 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
            text-decoration: none; color: inherit; /* Card is now a button/link */
        }

        .image-container { width: 100%; aspect-ratio: 1/1; background: #0a0a0a; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .item-image { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .item-info { padding: 10px; display: flex; flex-direction: column; gap: 4px; }
        .item-name { font-size: 13px; font-weight: 700; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .stock-row { display: flex; justify-content: space-between; align-items: center; margin-top: 2px; }
        .size-badge { font-size: 12px; font-weight: 600; color: var(--gray); }
        .stock-val { font-size: 12px; font-weight: 800; color: var(--accent); }

        .calc-box { 
            background: #050505; border: 1px solid #1a1a1a; border-radius: 8px; 
            padding: 8px; margin-top: 6px;
        }
        .calc-text { font-size: 9px; color: var(--gray); display: block; text-align: center; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .calc-math { font-size: 11px; text-align: center; color: #bbb; font-weight: 600; margin-bottom: 2px; }

        .total-price { 
            font-size: 15px; font-weight: 900; color: #fbbf24; 
            text-align: center; display: block;
        }

        #popupOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; backdrop-filter: blur(5px); }
        #recordSheet { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; border-top: 2px solid var(--accent); border-radius: 20px 20px 0 0; z-index: 5001; transform: translateY(100%); transition: transform 0.3s ease-out; padding: 20px; box-sizing: border-box; }
        .sheet-active { transform: translateY(0) !important; }
        .sheet-handle { width: 40px; height: 4px; background: #333; border-radius: 10px; margin: 0 auto 15px; }
        .record-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .record-option { background: #1a1a1a; border: 1px solid #222; padding: 15px; border-radius: 12px; color: var(--text); text-decoration: none; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 14px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: #000; display: flex; border-top: 1px solid var(--border); z-index: 4000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { color: var(--gray); flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; text-decoration: none; border: none; background: none; outline: none; }
        .nav-item.active { color: var(--accent); }
        .icon { width: 22px; height: 22px; margin-bottom: 4px; fill: currentColor; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="header">
        <input type="text" id="searchBar" class="search-bar" placeholder="Hming, Category, or Price search na...">
    </header>

    <div class="category-ribbon" id="categoryRibbon"></div>

    <main class="main-content" id="inventory-grid"></main>

    <div id="popupOverlay"></div>
    <div id="recordSheet">
        <div class="sheet-handle"></div>
        <div class="record-list">
            <a href="record.html" class="record-option"><span>ðŸ‘• Thawmhnaw Record Na</span><i class="fas fa-chevron-right"></i></a>
            <a href="s-record.html" class="record-option"><span>ðŸ©´ Slippers Record Na</span><i class="fas fa-chevron-right"></i></a>
            <a href="p-record.html" class="record-option"><span>ðŸ¥¤ Plastic Record Na</span><i class="fas fa-chevron-right"></i></a>
            <a href="t-record.html" class="record-option"><span>ðŸ§¸ Toys Record Na</span><i class="fas fa-chevron-right"></i></a>
            <a href="et-record.html" class="record-option"><span>âš¡ Toys Man To Record Na</span><i class="fas fa-chevron-right"></i></a>
            <a href="bag.html" class="record-option"><span>ðŸ’¼ Bag Record Na</span><i class="fas fa-chevron-right"></i></a>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="homepage.html" class="nav-item active"><svg class="icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>HOME</span></a>
        <button id="openRecord" class="nav-item hidden"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg><span>RECORD</span></button>
        <a href="admin.html" id="adminBtn" class="nav-item hidden"><svg class="icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg><span>ADMIN</span></a>
        <a href="account.html" class="nav-item"><svg class="icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>ACCOUNT</span></a>
    </nav>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUEe_nqxaUKrYBjSJssxuRzns8AHsLkX0",
            authDomain: "kimkimenterprise-516c4.firebaseapp.com",
            projectId: "kimkimenterprise-516c4",
            storageBucket: "kimkimenterprise-516c4.firebasestorage.app",
            messagingSenderId: "782456699398",
            appId: "1:782456699398:web:c069d267ea8d62b197e187"
        };

        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Permissions
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.isAdmin) {
                        document.getElementById('openRecord').classList.remove('hidden');
                        document.getElementById('adminBtn').classList.remove('hidden');
                    } else if (data.isAuthorized) {
                        document.getElementById('openRecord').classList.remove('hidden');
                    }
                }
            }
        });

        // Popup UI
        const openBtn = document.getElementById('openRecord');
        const overlay = document.getElementById('popupOverlay');
        const sheet = document.getElementById('recordSheet');
        openBtn.addEventListener('click', () => {
            overlay.style.display = 'block';
            setTimeout(() => sheet.classList.add('sheet-active'), 10);
        });
        overlay.addEventListener('click', () => {
            sheet.classList.remove('sheet-active');
            setTimeout(() => overlay.style.display = 'none', 300);
        });

        // Global State
        let allItems = [];
        let activeCat = 'All';

        // Load Data
        onSnapshot(collection(db, "inventory_item"), (snap) => {
            allItems = [];
            let catSet = new Set(['All']);
            
            snap.docs.forEach(doc => {
    const data = doc.data();
    const category = data.category || "General";
    catSet.add(category);
    
    // SAFETY CHECK: Only proceed if 'details' is an actual Array (List)
    if (data.details && Array.isArray(data.details)) {
        data.details.forEach(item => {
            // Additional safety for variations
            if (item.variations && Array.isArray(item.variations)) {
                item.variations.forEach(v => {
                    const uprice = parseFloat(v.price) || 0;
                    const incount = parseFloat(v.inner) || 1;
                    allItems.push({
                        docId: doc.id,
                        name: item.name,
                        category: category,
                        img: item.img || '',
                        size: v.size || '-',
                        qty: parseFloat(v.qty) || 0,
                        inner: incount,
                        unit: v.unit || 'set',
                        price: uprice,
                        total: uprice * incount
                    });
                });
            }
        });
    } else {
        // This helps you find the broken item in the console
        console.warn("Item structure is broken and was skipped:", doc.id);
    }
});
renderChips(Array.from(catSet));
render();
});

        // Category Rendering
        function renderChips(cats) {
            document.getElementById('categoryRibbon').innerHTML = cats.map(c => 
                `<div class="cat-chip ${activeCat === c ? 'active' : ''}" onclick="window.setCategory('${c}')">${c}</div>`
            ).join('');
        }

        // Search and Filter Rendering
        function render() {
            const term = document.getElementById('searchBar').value.toLowerCase().trim();
            const grid = document.getElementById('inventory-grid');

            const filtered = allItems.filter(i => {
    const matchesCat = (activeCat === 'All' || i.category === activeCat);
    
    // This removes all spaces from your search and the item name
    const cleanTerm = term.replace(/\s+/g, ''); 
    const cleanName = i.name.toLowerCase().replace(/\s+/g, '');
    
    // Now "3 ways" becomes "3ways" and "3wasy" stays "3wasy"
    // They will now match because "3way" is inside "3wasy"
    const matchesSearch = cleanName.includes(cleanTerm) || 
                         i.category.toLowerCase().includes(term) ||
                         `${i.price}${i.total}`.includes(term);

    return matchesCat && matchesSearch;
});

            grid.innerHTML = filtered.map(i => {
                const imageSrc = i.img && i.img.trim() !== "" ? i.img : 'https://via.placeholder.com/300/111/555?text=No+Photo';
                return `
                <a href="item-view.html?id=${i.docId}" class="item-card">
                    <div class="image-container"><img src="${imageSrc}" class="item-image" loading="eager"></div>
                    <div class="item-info">
                        <div class="item-name">${i.name}</div>
                        <div class="stock-row">
                            <span class="size-badge">SIZE: ${i.size}</span>
                            <span class="stock-val">${i.qty} ${i.unit.toUpperCase()}S</span>
                        </div>
                        <div class="calc-box">
                            <span class="calc-text">Rate Breakdown</span>
                            <div class="calc-math">â‚¹${i.price} Ã— ${i.inner} Pcs</div>
                            <span class="total-price">â‚¹${i.total.toLocaleString('en-IN')}</span>
                        </div>
                    </div>
                </a>`;
            }).join('');
        }

        // Global functions for window scope
        window.setCategory = (c) => {
            activeCat = c;
            // Update chip styles manually for speed
            document.querySelectorAll('.cat-chip').forEach(chip => {
                chip.classList.toggle('active', chip.innerText === c);
            });
            render();
        };

        document.getElementById('searchBar').addEventListener('input', render);
    </script>
</body>
</html>
