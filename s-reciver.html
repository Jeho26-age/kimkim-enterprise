<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Hub | Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #000; --card: #111; --accent: #4ade80; --border: #222; --text: #fff; --error: #ff4d4d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 100px; }
        .category-header { color: var(--accent); font-size: 10px; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px; text-transform: uppercase; }
        .bag-card { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 12px; margin-bottom: 20px; border-top: 4px solid var(--accent); position: relative; }
        .item-box { background: #080808; padding: 10px; border-radius: 12px; margin-top: 10px; border: 1px solid #1a1a1a; }
        .item-header { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; }
        .img-area { position: relative; width: 85px; height: 85px; flex-shrink: 0; }
        .item-img { width: 85px; height: 85px; object-fit: cover; border-radius: 8px; border: 1px solid #333; cursor: pointer; }
        .cam-btn { position: absolute; bottom: -5px; right: -5px; background: var(--accent); color: #000; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #000; font-size: 12px; z-index: 5; }
        input { background: #111; border: 1px solid #333; color: white; border-radius: 4px; padding: 5px; font-size: 13px; width: 100%; box-sizing: border-box; }
        .edit-grid { background: #161616; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #222; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; position: relative; }
        .label-text { font-size: 10px; color: #777; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .total-box { grid-column: span 2; background: #000; padding: 8px; border-radius: 4px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .total-val { color: var(--accent); font-weight: bold; }
        .inp-p { border: 1px solid var(--accent) !important; color: var(--accent); text-align: center; }
        .mizo-warn { color: var(--error); font-size: 9px; margin-top: 4px; display: block; font-weight: bold; }
        #autoCalcTrigger { position: fixed; bottom: 85px; right: 20px; background: var(--accent); color: #000; width: 60px; height: 60px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); z-index: 5000; border: 4px solid #000; }
        #summaryModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .summary-content { background: #111; border: 1px solid var(--accent); border-radius: 15px; padding: 20px; max-width: 500px; margin: auto; }
        #zoomOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; align-items: center; justify-content: center; }
        #zoomedImg { max-width: 95%; max-height: 85%; border-radius: 10px; border: 2px solid var(--accent); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #080808; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #222; z-index: 4000; }
        .nav-btn { background: none; border: none; color: #777; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    </style>
</head>
<body>

    <div id="display-list"></div>
    <div id="autoCalcTrigger" onclick="window.showSummary()"><i class="fa-solid fa-calculator"></i></div>
    <div id="zoomOverlay" onclick="this.style.display='none'"><img id="zoomedImg" src=""></div>

    <div id="summaryModal" onclick="this.style.display='none'">
        <div class="summary-content" onclick="event.stopPropagation()">
            <div id="summaryDate" style="text-align:center; color:var(--accent); font-weight:bold; font-size:18px; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;"></div>
            <div id="summaryBody"></div>
            <button onclick="document.getElementById('summaryModal').style.display='none'" style="width:100%; background:red; color:white; border:none; padding:12px; border-radius:8px; margin-top:20px; font-weight:bold;">CLOSE</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" onclick="location.href='history.html'"><i class="fa-solid fa-clock-rotate-left" style="font-size:20px;"></i>HISTORY</button>
        <button id="uploadAllBtn" onclick="window.uploadAll()" style="background:var(--accent); color:#000; border:none; padding:10px 20px; border-radius:30px; font-weight:bold; font-size:14px;"><i class="fa-solid fa-cloud-arrow-up"></i> UPLOAD ALL</button>
        <button class="nav-btn" onclick="location.reload()"><i class="fa-solid fa-rotate" style="font-size:20px;"></i>REFRESH</button>
    </div>

    <input type="file" id="fileIn" accept="image/*" hidden>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBUEe_nqxaUKrYBjSJssxuRzns8AHsLkX0",
        authDomain: "kimkimenterprise-516c4.firebaseapp.com",
        projectId: "kimkimenterprise-516c4",
        storageBucket: "kimkimenterprise-516c4.firebasestorage.app",
        messagingSenderId: "782456699398",
        appId: "1:782456699398:web:c069d267ea8d62b197e187"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let globalData = [];

   onSnapshot(collection(db, "SLIPPER_RECORDS"), (snapshot) => {

        const listDiv = document.getElementById('display-list');
        let html = "";
        globalData = [];

        snapshot.forEach((record) => {
            const data = record.data();
            (data.details || []).forEach((bag, bIdx) => {
                const uKey = `${record.id}_${bIdx}`;
                globalData.push({ id: record.id, ...data, currentBag: bag, bIdx, uKey });
                const lS = JSON.parse(localStorage.getItem(`edit_${uKey}`)) || {};
                window.triggerCam = (uKey, iIdx) => {
    const fileIn = document.getElementById('fileIn');
    fileIn.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64 = event.target.result;
            document.getElementById(`img_view_${uKey}_${iIdx}`).src = base64;
            window.updateLS(uKey, `img_${iIdx}`, base64);
        };
        reader.readAsDataURL(file);
    };
    fileIn.click();
};

                
                html += `<div class="bag-card">
                    <div class="category-header">${data.category}</div>
                    <span class="label-text">Bag / Consignment (Internal Only)</span>
                    <input type="text" id="bagNo_${uKey}" value="${lS.bagNo || bag.number}" oninput="window.updateLS('${uKey}','bagNo',this.value)" style="color:var(--accent); font-weight:bold; width:150px; margin-bottom:10px;">`;
                
                (bag.items || []).forEach((item, iIdx) => {
                    const currentImg = lS[`img_${iIdx}`] || item.img;
                    html += `<div class="item-box">
                        <div class="item-header">
                            <div class="img-area">
                                <img src="${currentImg}" class="item-img" id="img_view_${uKey}_${iIdx}" onclick="window.zoomImg(this.src)">
                                <div class="cam-btn" onclick="window.triggerCam('${uKey}',${iIdx})"><i class="fa-solid fa-camera"></i></div>
                            </div>
                            <div style="flex:1;"><span class="label-text">Item Name</span>
                            <input type="text" value="${lS[`name_${iIdx}`] || item.name}" oninput="window.updateLS('${uKey}','name_${iIdx}',this.value)"></div>
                        </div>`;
                    
                    (item.variations || []).forEach((v, vIdx) => {
                        const key = `${iIdx}_${vIdx}`;
                        const q = lS[`q_${key}`] !== undefined ? lS[`q_${key}`] : (v.qty || 0);
                        const iQ = lS[`i_${key}`] !== undefined ? lS[`i_${key}`] : (v.innerQty || 1);
                        const price = lS[`p_${key}`] || '';
                        
                        html += `<div class="edit-grid">
                            <div><span class="label-text">Size</span><input type="text" value="${lS[`sz_${key}`] || v.size}" oninput="window.updateLS('${uKey}','sz_${key}',this.value)"></div>
                            <div><span class="label-text">Qty</span>
                                <input type="number" id="q_${uKey}_${key}" value="${q}" oninput="window.liveCalc('${uKey}','${key}','q',this.value)">
                            </div>
                            <div><span class="label-text">Unit</span><input type="text" value="${lS[`u_${key}`] || v.unit || 'set'}" oninput="window.updateLS('${uKey}','u_${key}',this.value)"></div>
                            <div><span class="label-text">Inner</span><input type="number" id="i_${uKey}_${key}" value="${iQ}" oninput="window.liveCalc('${uKey}','${key}','i',this.value)"></div>
                            <div class="total-box"><span class="label-text">Total Pcs:</span><span class="total-val" id="total_${uKey}_${key}">${q * iQ}</span></div>
                            <div class="price-group"><span class="label-text">Price</span>
                                <input type="number" class="inp-p" value="${price}" oninput="window.updateLS('${uKey}','p_${key}',this.value)">
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
            });
        });
        listDiv.innerHTML = html;
        document.getElementById('autoCalcTrigger').style.display = globalData.length > 0 ? 'flex' : 'none';
    });

    // 2. The Calculator Snapshot Logic
    const getCalculatorData = () => {
        const consMap = {};
        globalData.forEach(entry => {
            const lS = JSON.parse(localStorage.getItem(`edit_${entry.uKey}`)) || {};
            const cNo = lS.bagNo || entry.currentBag.number;
            if (!consMap[cNo]) consMap[cNo] = { bagCount: 0, items: {}, grandTotal: 0 };
            consMap[cNo].bagCount++;
            entry.currentBag.items.forEach((item, iIdx) => {
                const iName = lS[`name_${iIdx}`] || item.name;
                if (!consMap[cNo].items[iName]) consMap[cNo].items[iName] = {};
                item.variations.forEach((v, vIdx) => {
                    const key = `${iIdx}_${vIdx}`;
                    const sz = lS[`sz_${key}`] || v.size;
                    const qty = parseFloat(lS[`q_${key}`] || v.qty || 0);
                    const inner = parseFloat(lS[`i_${key}`] || v.innerQty || 1);
                    const total = qty * inner;
                    if (!consMap[cNo].items[iName][sz]) consMap[cNo].items[iName][sz] = { qty: 0, totalPcs: 0, unit: lS[`u_${key}`] || v.unit || 'set' };
                    consMap[cNo].items[iName][sz].qty += qty;
                    consMap[cNo].items[iName][sz].totalPcs += total;
                    consMap[cNo].grandTotal += total;
                });
            });
        });
        return consMap;
    };

    // 3. The Double-Push Upload Function
        window.uploadAll = async () => {
        const btn = document.getElementById('uploadAllBtn');
        
        // --- 1. THE GATEKEEPER (VALIDATION) ---
        let isValid = true;
        globalData.forEach(entry => {
            const lS = JSON.parse(localStorage.getItem(`edit_${entry.uKey}`)) || {};
            entry.currentBag.items.forEach((item, iIdx) => {
                item.variations.forEach((v, vIdx) => {
                    const key = `${iIdx}_${vIdx}`;
                    const q = lS[`q_${key}`] !== undefined ? lS[`q_${key}`] : v.qty;
                    const p = lS[`p_${key}`] || '';
                    
                    if (!p || p === '' || q == 0) {
                        isValid = false;
                    }
                });
            });
        });

        if (!isValid) {
            alert("Hriattirna: Price emaw Qty i la dah khat lo! Khawngaihin enfiah leh hmasa rawh.");
            return; // Stops the function here
        }

        // --- 2. THE UPLOAD LOGIC (Only runs if isValid is true) ---
        btn.disabled = true; btn.innerHTML = "DAH LUH MEK A NI...";
        
        const dateStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        const timeStr = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        try {
            const fullSummary = getCalculatorData();
            await addDoc(collection(db, "history_data"), {
                category: "SLIPPER",
                date: dateStr,
                time: timeStr,
                snapshot: fullSummary,
                timestamp: serverTimestamp()
            });

            for (const entry of globalData) {
                const lS = JSON.parse(localStorage.getItem(`edit_${entry.uKey}`)) || {};
                const cleanItemData = {
                    category: "SLIPPER",
                    date: dateStr,
                    timestamp: serverTimestamp(),
                    details: entry.currentBag.items.map((item, iIdx) => ({
                        name: lS[`name_${iIdx}`] || item.name,
                        img: lS[`img_${iIdx}`] || item.img,
                        variations: item.variations.map((v, vIdx) => {
                            const key = `${iIdx}_${vIdx}`;
                            const q = parseFloat(lS[`q_${key}`] !== undefined ? lS[`q_${key}`] : (v.qty || 0));
                            const iQ = parseFloat(lS[`i_${key}`] !== undefined ? lS[`i_${key}`] : (v.innerQty || 1));
                            return {
    size: lS[`sz_${key}`] || v.size,
    qty: q,
    inner: iQ,
    stock: q * iQ,
    price: lS[`p_${key}`],
    unit: lS[`u_${key}`] || v.unit || 'set'
};

                        })
                    }))
                };

                await addDoc(collection(db, "inventory_item"), cleanItemData);
                localStorage.removeItem(`edit_${entry.uKey}`);
            }

            const ids = [...new Set(globalData.map(g => g.id))];
            for (const id of ids) await deleteDoc(doc(db, "pending_approvals", id));

            alert("Hlawhtling takin i dah lut ta e!");
            location.reload();
        } catch (e) { 
            console.error(e);
            alert("A harsa tlat, i internet check la, han try nawn leh teh."); 
            btn.disabled = false; btn.innerHTML = "UPLOAD ALL"; 
        }
    };

    // Standard UI Helpers
    window.updateLS = (uK, k, v) => {
        const d = JSON.parse(localStorage.getItem(`edit_${uK}`)) || {};
        d[k] = v; localStorage.setItem(`edit_${uK}`, JSON.stringify(d));
    };
    window.liveCalc = (uK, k, t, v) => {
        window.updateLS(uK, `${t}_${k}`, v);
        const q = document.getElementById(`q_${uK}_${k}`).value || 0;
        const i = document.getElementById(`i_${uK}_${k}`).value || 1;
        document.getElementById(`total_${uK}_${k}`).innerText = q * i;
    };
    window.zoomImg = (src) => { 
        document.getElementById('zoomedImg').src = src; 
        document.getElementById('zoomOverlay').style.display = 'flex'; 
    };
    window.showSummary = () => {
        const summaryBody = document.getElementById('summaryBody');
        const consMap = getCalculatorData();
        let sHtml = "";
        for (const [cNo, data] of Object.entries(consMap)) {
            sHtml += `<div style="color:var(--accent); font-size:16px; border-bottom:1px solid #333; margin-top:15px; display:flex; justify-content:space-between;">
                <span>Consignment: ${cNo}</span>
                <span style="background:var(--accent); color:#000; padding:0 8px; border-radius:4px; font-weight:bold; font-size:12px;">${data.bagCount} BAGS</span>
            </div>`;
            for (const [iName, sizes] of Object.entries(data.items)) {
                sHtml += `<div style="color:#fff; margin-top:5px; font-weight:bold;">${iName}</div>`;
                for (const [sz, info] of Object.entries(sizes)) {
                    sHtml += `<div style="font-size:12px; color:#aaa; padding-left:10px;">- Size ${sz}: ${info.qty} ${info.unit} = ${info.totalPcs} pcs</div>`;
                }
            }
            sHtml += `<div style="text-align:right; color:var(--accent); font-weight:bold; margin-top:5px;">Total: ${data.grandTotal} pcs</div>`;
        }
        summaryBody.innerHTML = sHtml || "No Data";
        document.getElementById('summaryModal').style.display = 'block';
    };
</script>

</body>
</html>
